---
- name:       check ServerDesity agent directory
  stat:
    path:     "{{ serverdensity_directory }}"
  register:   serverdensity_directory_status

- name:       check if ServerDesity is installed
  set_fact:
    serverdensity_not_installed: "{{ not (serverdensity_directory_status.stat.isreg is defined and serverdensity_directory_status.stat.isreg) }}"

- name:       Install ServerDesity if required
  include:    install.yml
  when:       serverdensity_not_installed or serverdensity_force_install

- name:       check ServerDesity agent directory again
  stat:
    path:     "{{ serverdensity_directory }}"
  register:   serverdensity_directory_status

- name:       check again if ServerDesity is installed
  set_fact:
    serverdensity_is_installed: "{{ serverdensity_directory_status.stat.isreg is defined and serverdensity_directory_status.stat.isreg}}"

- name:       Update System Attributes if ServerDesity is insalled
  include:    update_system.yml
  when:       serverdensity_is_installed
...
